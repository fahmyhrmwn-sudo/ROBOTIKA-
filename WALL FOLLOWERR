// === Pin Ultrasonic ===
// Sensor kiri
#define TRIG_L A0
#define ECHO_L A1

// Sensor tengah
#define TRIG_C A2
#define ECHO_C A3

// Sensor kanan
#define TRIG_R A4
#define ECHO_R A5


// === Pin Motor Driver L298N ===
#define ENA 5    // PWM
#define IN1 3
#define IN2 4
#define IN3 2
#define IN4 7
#define ENB 6    // PWM

unsigned long prevMillis = 0;
const unsigned long interval = 250; // jeda 250 ms


// === Variabel Global ===
int distL, distC, distR;
int speedForward = 70;
int speedTurn = 50;     // <<< speed belok (lebih pelan)
int speedBack = 50;     // <<< optional, mundur



// === Fungsi baca satu ultrasonic ===
long readUltrasonic(int trigPin, int echoPin) {

  delayMicroseconds(5);

  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(3);
  digitalWrite(trigPin, LOW);

  long duration = pulseIn(echoPin, HIGH, 40000);

  if (duration == 0) return 300;
  return duration * 0.034 / 2;
}


// === Gerak Motor ===
void moveForward() {
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
  analogWrite(ENA, speedForward);
  analogWrite(ENB, speedForward);
}

void moveBackward() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);
  analogWrite(ENA, speedBack);
  analogWrite(ENB, speedBack);
}

void turnLeft() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, HIGH);
  digitalWrite(IN3, HIGH);
  digitalWrite(IN4, LOW);
  analogWrite(ENA, 50);            // kiri berhenti
  analogWrite(ENB, 70);    // kanan jalan
}

void turnRight() {
  digitalWrite(IN1, HIGH);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, HIGH);
  analogWrite(ENA, 70);   // kiri jalan
  analogWrite(ENB, 45);           // kanan berhenti
}

void stopMove() {
  digitalWrite(IN1, LOW);
  digitalWrite(IN2, LOW);
  digitalWrite(IN3, LOW);
  digitalWrite(IN4, LOW);
}


// === Setup ===
void setup() {
  Serial.begin(9600);

  pinMode(TRIG_L, OUTPUT);
  pinMode(ECHO_L, INPUT_PULLUP);

  pinMode(TRIG_C, OUTPUT);
  pinMode(ECHO_C, INPUT);

  pinMode(TRIG_R, OUTPUT);
  pinMode(ECHO_R, INPUT);

  pinMode(IN1, OUTPUT);
  pinMode(IN2, OUTPUT);
  pinMode(IN3, OUTPUT);
  pinMode(IN4, OUTPUT);
  pinMode(ENA, OUTPUT);
  pinMode(ENB, OUTPUT);

  stopMove();
  Serial.println("Robot 3 Ultrasonik Siap Jalan!");
}


// === LOOP UTAMA ===
void loop() {

  if (millis() - prevMillis >= interval) {
    prevMillis = millis();

    distL = readUltrasonic(TRIG_L, ECHO_L);
    distC = readUltrasonic(TRIG_C, ECHO_C);
    distR = readUltrasonic(TRIG_R, ECHO_R);

    Serial.print("L: "); Serial.print(distL);
    Serial.print("  C: "); Serial.print(distC);
    Serial.print("  R: "); Serial.println(distR);

    int batasC = 20;
    int batasL = 5;
    int batasR = 5;

    // 1. Depan terhalang â†’ mundur + pilih arah
    if (distC < batasC) {
      moveBackward();

      if (distL > distR) turnLeft();
      else turnRight();
    }

    // 2. Kiri terhalang
    else if (distL < batasL) {
      turnRight();
    }

    // 3. Kanan terhalang
    else if (distR < batasR) {
      turnLeft();
    }

    // 4. Aman
    else {
      moveForward();
    }
  }
  delay(30);
}
